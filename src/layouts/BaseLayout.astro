---
// BaseLayout.astro - Layout base siguiendo mejores pr치cticas de Astro
// Basado en: https://docs.astro.build/es/basics/layouts/

import "../styles/globals.css";

// Componentes comunes
import HeaderNav from "../components/HeaderNav.astro";
import ContactSection from "../components/ui/ContactSection.astro";
import Footer from "../components/ui/Footer.astro";
import ScrollToTop from "../components/ui/ScrollToTop.astro";

// Strapi integration
import strapi from "../utils/strapi";
import type { StrapiEntity, Header as HeaderType } from "../types/strapi";

// Props interface con TypeScript para type safety
export interface Props {
  pageTitle: string;
  metaDescription?: string;
  canonicalUrl?: string;
  ogImage?: string;
  showBreadcrumb?: boolean;
  breadcrumbItems?: Array<{ href: string; text: string }>;
  showContact?: boolean;
  contactConfig?: {
    highlightText?: string;
    title?: string;
    subtitle?: string;
    phone?: string;
    email?: string;
    address?: string;
    accentColor?: string;
    backgroundColor?: string;
    placeholder?: string;
  };
}

// Destructurar props con valores por defecto
const {
  pageTitle,
  metaDescription = "SJT Contratistas - Especializados en construcci칩n, obra civil, terracer칤as y desarrollo integral de proyectos en el sureste mexicano.",
  canonicalUrl,
  ogImage,
  showBreadcrumb = false,
  breadcrumbItems = [],
  showContact = true,
  contactConfig = {
    highlightText: "cont치ctanos hoy",
    title: "쯃ISTO PARA TU PR칍XIMO PROYECTO?",
    subtitle:
      "Nuestro equipo est치 preparado para hacer realidad tus ideas. Contact치nos para una consulta personalizada sin compromiso.",
    phone: "(993) 167-4490",
    email: "asastre@sjtcontratistas.com",
    address: "Carr. Reforma-Dos Bocas s/n, Cumuapa 1ra. Tabasco",
    accentColor: "var(--orange)",
    backgroundColor: "bg-dark",
    placeholder: "Cu칠ntanos sobre tu proyecto...",
  },
} = Astro.props;

// 游 OPTIMIZACI칍N CR칈TICA: Usar DataManager con cache para evitar llamadas duplicadas
// Antes: Cada p치gina llamaba getActiveHeader() = 4+ llamadas al mismo endpoint
// Despu칠s: Una sola llamada con cache compartido entre todas las p치ginas
import DataManager from "../utils/dataManager";

let headerData: StrapiEntity<HeaderType> | null = null;
let headerError: string | null = null;

try {
  console.log("游댌 BaseLayout: Obteniendo header con cache centralizado...");
  const startTime = performance.now();

  // Usar DataManager en lugar de llamada directa a strapi
  headerData = await DataManager.getHeader();

  const endTime = performance.now();
  const duration = endTime - startTime;

  if (headerData) {
    console.log(
      `游 Header obtenido desde DataManager en ${duration.toFixed(2)}ms:`,
      headerData.companyName
    );
  } else {
    console.log("丘멆잺 No se encontr칩 header activo en DataManager");
  }

  // Mostrar estad칤sticas de cache
  const stats = DataManager.getStats();
  console.log(
    `游늵 Cache Stats - Hit Rate: ${stats.hitRate}, Avg Time: ${stats.avgTime}`
  );
} catch (e) {
  headerError = e instanceof Error ? e.message : "Error loading header";
  console.warn("丘멆잺 Header DataManager error:", headerError);
}

// Transformar datos del header para el componente
const headerProps = headerData
  ? {
      companyName: headerData.companyName,
      logoFile: headerData.logoFile
        ? {
            url: headerData.logoFile.url,
            alternativeText: headerData.logoFile.alternativeText,
            name: headerData.logoFile.name,
            width: headerData.logoFile.width,
            height: headerData.logoFile.height,
          }
        : null,
    }
  : null;

// URLs can칩nicas y p치gina actual
const currentUrl = Astro.url.pathname;
const siteUrl = Astro.site || "https://sjtcontratistas.com"; // Fallback por si no est치 configurado
const fullCanonicalUrl = canonicalUrl || new URL(currentUrl, siteUrl).href;

// Navegaci칩n principal (configurable por p치gina si es necesario)
const mainNavLinks = [
  { href: "/", text: "Inicio" },
  { href: "/quienes-somos", text: "Qui칠nes Somos" },
  { href: "/servicios", text: "Servicios" },
  { href: "/portafolio", text: "Portafolio" },
];
---

<!doctype html>
<html lang="es">
  <head>
    <!-- Meta tags esenciales -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO b치sico -->
    <title>{pageTitle} - SJT Contratistas</title>
    <meta name="description" content={metaDescription} />
    <link rel="canonical" href={fullCanonicalUrl} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={fullCanonicalUrl} />
    <meta property="og:title" content={`${pageTitle} - SJT Contratistas`} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:image" content={ogImage || `${siteUrl}/og-image.jpg`} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={fullCanonicalUrl} />
    <meta name="twitter:title" content={`${pageTitle} - SJT Contratistas`} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={ogImage || `${siteUrl}/og-image.jpg`} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Preconnect para performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  </head>

  <body>
    <!-- Header Navigation (com칰n en todas las p치ginas) -->
    {
      headerProps ? (
        <HeaderNav
          companyName={headerProps.companyName}
          logoFile={headerProps.logoFile}
          sticky={false}
          transparent={true}
          navLinks={mainNavLinks}
          ctaText="Contactar"
          ctaHref="#contacto"
        />
      ) : (
        <HeaderNav
          companyName="SJT Contratistas"
          sticky={false}
          transparent={true}
          navLinks={mainNavLinks}
          ctaText="Solicitar Cotizaci칩n"
          ctaHref="#contacto"
        />
      )
    }

    <!-- Breadcrumb Navigation (opcional) -->
    {
      showBreadcrumb && breadcrumbItems.length > 0 && (
        <section class="bg-gray-50 py-4">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav
              class="flex text-sm font-medium text-gray-600"
              aria-label="Breadcrumb"
            >
              {breadcrumbItems.map((item, index) => (
                <Fragment>
                  {index === breadcrumbItems.length - 1 ? (
                    <span class="text-orange-600" aria-current="page">
                      {item.text}
                    </span>
                  ) : (
                    <>
                      <a
                        href={item.href}
                        class="hover:text-orange-600 transition-colors"
                      >
                        {item.text}
                      </a>
                      <span class="mx-2">/</span>
                    </>
                  )}
                </Fragment>
              ))}
            </nav>
          </div>
        </section>
      )
    }

    <!-- Main Content (aqu칤 se inyecta el contenido espec칤fico de cada p치gina) -->
    <main id="main-content">
      <slot />
    </main>

    <!-- Contact Section (opcional, com칰n en la mayor칤a de p치ginas) -->
    {
      showContact ? (
        <section id="contacto">
          <ContactSection
            highlightText={contactConfig.highlightText!}
            title={contactConfig.title!}
            subtitle={contactConfig.subtitle!}
            phone={contactConfig.phone!}
            email={contactConfig.email!}
            address={contactConfig.address!}
            accentColor={contactConfig.accentColor!}
            backgroundColor={contactConfig.backgroundColor!}
            placeholder={contactConfig.placeholder!}
          />
        </section>
      ) : null
    }

    <!-- Footer (com칰n en todas las p치ginas) -->
    <Footer
      companyName={headerProps?.companyName || "SJT Contratistas S.A. de C.V."}
      quickLinks={mainNavLinks}
      contactInfo={{
        email: contactConfig.email!,
        phone: contactConfig.phone!,
        address: contactConfig.address!,
      }}
      showSocialLinks={false}
    />

    <!-- Scroll to Top Button (com칰n en todas las p치ginas) -->
    <ScrollToTop />

    <!-- Scripts globales si los necesitas -->
    <script>
      // Scripts comunes para todas las p치ginas

      // Smooth scrolling para enlaces internos
      document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
        anchor.addEventListener("click", function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute("href"));
          if (target) {
            target.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }
        });
      });

      // Analytics o tracking (si los tienes)
      // GTM, Google Analytics, etc.
    </script>
  </body>
</html>

<style>
  /* Estilos globales para el layout */

  /* Smooth scrolling global */
  html {
    scroll-behavior: smooth;
  }

  /* Mejoras de accesibilidad */
  @media (prefers-reduced-motion: reduce) {
    html {
      scroll-behavior: auto;
    }

    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Skip links para accesibilidad */
  .skip-link {
    position: absolute;
    top: -40px;
    left: 6px;
    background: #000;
    color: white;
    padding: 8px;
    text-decoration: none;
    transition: top 0.3s;
    z-index: 1000;
  }

  .skip-link:focus {
    top: 6px;
  }

  /* Asegurar que el main tenga el spacing correcto */
  main {
    position: relative;
    z-index: 1;
  }

  /* Focus visible para accesibilidad */
  a:focus-visible,
  button:focus-visible,
  input:focus-visible,
  textarea:focus-visible,
  select:focus-visible {
    outline: 2px solid #ff5722;
    outline-offset: 2px;
  }
</style>
